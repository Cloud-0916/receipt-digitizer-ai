## Receipt Digitizer AI

レシート・領収書画像から構造化データを自動抽出するAIアプリケーション

## 作成目的

私は月に一度、自身のお金の出入歴リスト化しており、その作業の効率化をしたく作成した。

## 概要

本プロジェクトは、紙のレシートや領収書をスマートフォンで撮影した画像から、店舗名・日付・金額などの情報を自動抽出し、CSV形式で出力するWebアプリケーションです。

**画像処理（OpenCV）** × **文字認識（OCR）** × **大規模言語モデル（LLM）** を組み合わせた、実務で活用可能なAIパイプラインを実装しています。

###  解決する課題

- 経費精算時のレシート手入力の手間
- 紙の領収書のデジタル管理
- 会計データの自動構造化

## デモ

[アプリケーション画面](http://localhost:8501/)

**主な機能：**
1. レシート画像のドラッグ＆ドロップアップロード
2. リアルタイムでの画像前処理プレビュー
3. OCR結果と構造化JSONの表示
4. CSVファイルのワンクリックダウンロード

## システムアーキテクチャ
```
┌─────────────────────────────────────────────────────────────────┐
│                        Streamlit UI                             │
│                   （ブラウザベースUI）                            │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    preprocessing.py                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │グレースケール│→│ノイズ除去   │→│ 適応的二値化                │   │
│  │   変換      │  │(MedianBlur) │  │(Adaptive Threshold)     │   │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      ocr_engine.py                              │
│                 EasyOCR (日本語 + 英語)                          │
│                   文字領域検出 → テキスト抽出                     │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      llm_parser.py                              │
│                  Groq API (Llama 3.3 70B)                       │
│              プロンプトエンジニアリングによるJSON抽出              │
└─────────────────────┬───────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    構造化データ出力                              │
│                  JSON / CSV / DataFrame                         │
└─────────────────────────────────────────────────────────────────┘
```

## 技術スタック

| カテゴリ | 技術 | 選定理由 |
|---------|------|----------|
| 言語 | Python 3.12 | AI/ML領域での豊富なライブラリ |
| 画像処理 | OpenCV | 高速な画像処理、豊富な前処理機能 |
| OCR | EasyOCR | 日本語対応、Tesseractより高精度 |
| LLM | Groq API (Llama 3.3) or gemini API (gemini-2.0-flash)| 無料枠があり、高速推論 |
| UI | Streamlit | Pythonのみで完結、迅速なプロトタイピング |

## 技術的なハイライト

### 1. 適応的二値化による照明ムラ対策

**課題：** 大津の二値化（グローバル閾値）では、影や照明ムラのある画像で文字が黒く塗りつぶされる問題が発生。

**解決策：** 適応的二値化（Adaptive Threshold）を採用し、画像の局所領域ごとに閾値を動的に計算。
```python
# 従来の大津の二値化（問題あり）
_, binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

# 採用した適応的二値化（照明ムラに強い）
binary = cv2.adaptiveThreshold(
    denoised, 255,
    cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
    cv2.THRESH_BINARY, 11, 2
)
```

### 2. OCRエンジンの比較検証

| エンジン | 日本語精度 | 処理速度 | 採用 |
|---------|-----------|---------|------|
| Tesseract | △ 低い | ○ 速い | × |
| EasyOCR | ○ 高い | △ やや遅い | ✓ |

Tesseractでは日本語レシートの認識精度が低く、文字化けが多発。EasyOCRに切り替えることで大幅に改善。

### 3. LLMによるOCR誤読の補正

OCR結果には誤字脱字が含まれるため、LLMのコンテキスト理解能力を活用して補正。

**プロンプト設計のポイント：**
- 出力形式をJSON Schemaで厳密に指定
- 不明な場合は `null` を返すよう指示（ハルシネーション対策）
- 余計な解説を出力しないよう制約
```python
prompt = """以下のテキストはレシートをOCRした結果です。
誤字脱字が含まれる可能性があります。
このテキストから情報を抽出し、以下のJSON形式のみを出力してください。
余計な解説は不要です。不明な場合はnullを入れてください。
..."""
```

## セットアップ

### 必要要件

- Python 3.10以上
- Groq APIキー（[無料取得](https://console.groq.com/keys)）
- gemini APIキー（[無料取得](https://aistudio.google.com/api-keys)）

### インストール手順
```bash
# 1. リポジトリをクローン
git clone https://github.com/yourusername/receipt-digitizer-ai.git
cd receipt-digitizer-ai

# 2. 仮想環境を作成・有効化
python -m venv venv
.\venv\Scripts\Activate    # Windows
source venv/bin/activate   # Mac/Linux

# 3. 依存関係をインストール
pip install -r requirements.txt

# 4. 環境変数を設定
echo "GROQ_API_KEY=your_api_key_here" > .env
     "gemini_API_KEY=your_api_key_here" > .env

# 5. アプリを起動
streamlit run app.py
```

## プロジェクト構成
```
receipt-digitizer-ai/
├── app.py                 # Streamlit UIメインファイル
├── preprocessing.py       # 画像前処理モジュール
├── ocr_engine.py          # OCRエンジンモジュール
├── llm_parser.py          # LLM構造化モジュール
├── requirements.txt       # 依存関係
├── .env                   # 環境変数（Git管理外）
├── .gitignore
├── data/
│   ├── raw/               # 元画像
│   └── processed/         # 処理済み画像
└── docs/
    └── demo.png           # デモ画像
```

## 今後の改善計画

以前までは店舗ベースの出金歴だったが、購入品目等にまで細分化した内容を記録できるように精度向上に努めたい。

| 優先度 | 改善内容 | 期待効果 |
|-------|---------|---------|
| 高 | Google Cloud Vision API対応 | OCR精度の大幅向上 | ※デプロイを優先したため、精度は現時点でとても低い
| 中 | 複数レシート一括処理 | 業務効率化 |
| 中 | ユーザー修正UIの追加 | データ精度向上 |
| 低 | 多言語対応 | 海外レシート対応 |

## 学んだこと

- 画像前処理がOCR精度に与える影響の大きさ
- 無料APIの制限内での開発手法
- LLMプロンプト設計によるハルシネーション対策
- Streamlitを用いた迅速なプロトタイピング